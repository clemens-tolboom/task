<?php
/* $Id$ */

/**
 * @file
 * A task module for managing tasks.
 *
 * This module allows users and groups to manage tasks.
 * TODO: add more!
 */

/**
 * Implementation of hook_help().
 */
function task_help($section) {
  switch ($section) {
// TODO: Fix these descriptions!
    case 'admin/modules#description':
      // This description is shown in the listing at admin/modules.
      return t('Task manager for users and groups.');
    case 'node/add#task':
      // This description shows up when users click "create content."
      return t('Creates a task.');
  }
}

/**
 * Implementation of hook_node_name().
 */
function task_node_name($node) {
  return t('task');
}

/**
 * Implementation of hook_perm().
 */
function task_perm() {
  return array('create task',
               'access task',
               'edit task');
}

/**
 * Implementation of hook_access().
 */
function task_access($op, $node) {
  global $user;

  if ($op == 'create') {
    return user_access('create task') && $user->uid;
  }

  if ($op == 'update' || $op == 'delete') {
    if (user_access('edit task') && ($user->uid == $node->uid)) {
      return TRUE;
    }
  }
/*
  switch ($op) {
    case 'view':
      return user_access('access task') ||
            (user_access('access own task') && $node->uid == $user->uid);
    case 'create':
      return user_access('create task') && $user->uid;
    case 'update':
    case 'delete':
      return $user->uid &&
            ($user->uid == $node->uid || user_access('edit own task'));
  }
*/
}

/**
 * Implementation of hook_menu().
 */
function task_menu($may_cache) {
  $items = array();

  if ($may_cache) {
  	$items[] = array('path' => 'tasks', 'title' => t('tasks'),
      'callback' => 'task_page_overview',
      'access' => user_access('access task'));

    $items[] = array('path' => 'node/add/task', 'title' => t('task'),
      'access' => user_access('create task'));
  }

  return $items;
}

/**
 * Implementation of hook_form().
 */
function task_form(&$node) {
  $output = '';

  // In order to be able to attach taxonomy terms to this node, we need
  // to display the appropriate form elements.
  if (function_exists('taxonomy_node_form')) {
    $output .= implode('', taxonomy_node_form('task', $node));
  }

  // Now we define the form elements specific to our node type.
  $output .= form_textarea(t('Body'), 'body', $node->body, 60, 20, '', NULL, TRUE);
  $output .= filter_form('format', $node->format);

  return $output;
}

/**
 * Implementation of hook_validate().
 */
function task_validate(&$node) {

// TODO: Is there a better way to do this? (require preview)
  // Bail if user hasn't done a preview yet.
  if (!isset($node->title)) {
    return $node;
  }

  // Make sure title isn't already in use
  if (db_num_rows(db_query("SELECT nid FROM {node} WHERE type = '%s' AND status = 1 AND title = '%s' AND nid <> %d", $node->type, $node->title, $node->nid))) {
    form_set_error('title', t('This task name is already in use.'));
  }

  // We need a description.
  if (empty($node->body)) {
    form_set_error('body', t('You must add a task description.'));
  }

  return $node;
}

/**
 * Implementation of hook_insert().
 */
function task_insert($node) {
  $taskid = db_next_id('task_id');
  db_query("INSERT INTO {task} (id, nid) VALUES (%d, %d)", $taskid, $node->nid);
}

/**
 * Implementation of hook_update().
 */
function task_update($node) {
  $taskid = db_result(db_query("SELECT id FROM {sequences} WHERE name = '%s'", 'task_id'));
  db_query("UPDATE {task} SET id = %d WHERE nid = %d", $taskid,  $node->nid);
}

/**
 * Implementation of hook_delete().
 */
function task_delete($node) {
  db_query('DELETE FROM {task} WHERE nid = %d', $node->nid);
}

/**
 * Implementation of hook_load().
 */
/*function task_load($node) {
  $additions = db_fetch_object(db_query('SELECT color, quantity FROM {tasks} WHERE nid = %d', $node->nid));
  return $additions;
}
*/

/**
 * Implementation of hook_view().
 */
/*function task_view(&$node, $teaser = FALSE, $page = FALSE) {
  $order_info = theme('task_order_info', $node);
  $node->body .= $order_info;
  $node->teaser .= $order_info;
  $node = node_prepare($node, $teaser);
}
*/

/**
 * Menu callback; display a list of tasks.
 */
// TODO: _task_page_overview?
function task_page_overview() {
  global $user;

  // Fetch all tasks.
  $result = db_query(db_rewrite_sql("SELECT n.nid, n.title, n.body, n.format, t.id FROM {node} n INNER JOIN {task} t ON n.nid = t.nid WHERE n.status = 1 ORDER BY n.title ASC"));

  $header = array(
    array('data' => t('#')),
    array('data' => t('Summary')),
    array('data' => t('Priority')),
    array('data' => t('Status')),
    array('data' => t('Due Date')),
    array('data' => t('Category'))
  );

  $rows = array();
  while ($node = db_fetch_object($result)) {
    $rows[] = array($node->id, theme('task_summary', $node), '', '', '', '');
  }

  $tasks = theme('table', $header, $rows, array('id' => 'tasks_overview'));

  $output .= '<br /> <div class="tasks">' .
             form_group(t('%user\'s tasks', array('%user' => $user->name)), $tasks) .
             '</div>';

  return $output;
}

/**
 * Theme the task summary page.
 */
function theme_task_summary($node) {
  return l($node->title, "node/$node->nid");
}
?>
